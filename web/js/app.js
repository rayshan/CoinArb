// Generated by CoffeeScript 1.6.3
(function() {
  angular.module('app', ['ngResource', 'ngAnimate', 'btford.socket-io', 'poller']);

  angular.module('app').run(function(tickerSvc) {});

  angular.module('app').factory('exchangeSvc', function() {
    var data;
    data = {
      mtgox: {
        id: 'mtgox',
        displayNameEng: 'Mt. Gox',
        defaultCurrency: 'USD',
        website: 'https://mtgox.com/',
        api: {
          type: 'ws',
          uri: 'https://data.mtgox.com/api/2/BTCUSD/money/ticker_fast'
        },
        fetched: {
          current: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          },
          previous: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          }
        }
      },
      btcchina: {
        id: 'btcchina',
        displayName: 'BTC China',
        displayNameLocal: '比特币中国',
        defaultCurrency: 'CNY',
        website: 'https://btcchina.com',
        api: {
          type: 'REST',
          uri: 'https://data.btcchina.com/data/ticker'
        },
        fetched: {
          current: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          },
          previous: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          }
        }
      },
      localbitcoins: {
        id: 'localbitcoins',
        displayName: 'LocalBitcoins.com',
        defaultCurrency: 'USD',
        website: 'https://localbitcoins.com',
        api: {
          type: 'REST',
          uri: 'https://api.bitcoinaverage.com/exchanges/USD'
        },
        fetched: {
          current: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          },
          previous: {
            bid: null,
            ask: null,
            last: null,
            updateTime: null,
            error: null
          }
        }
      }
    };
    return {
      data: data
    };
  });

  angular.module('app').factory('notificationSvc', function() {
    return {
      enabled: false,
      create: function(data) {
        var n;
        if (Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
        n = new Notification('yo', {
          body: data
        });
      }
    };
  });

  angular.module('app').factory('tickerSvc', function(exchangeSvc, $http, $timeout, $resource, poller, notificationSvc, $rootScope, $filter) {
    var USDCNY, callback, checkAndCopy, data, myResource, name, pollers, _i, _len, _ref;
    USDCNY = 6.05;
    pollers = [];
    checkAndCopy = function(id, current) {
      var check, data, now;
      now = moment().second();
      data = exchangeSvc.data[id].fetched;
      check = current.bid !== data.current.bid || current.ask !== data.current.ask || current.last !== data.current.last;
      if (check) {
        current.updateTime = now;
        angular.copy(data.current, data.previous);
        angular.copy(current, data.current);
        console.log(current);
        console.log(exchangeSvc.data[id].fetched);
        $rootScope.$broadcast("" + id + "Update");
      }
    };
    callback = {
      btcchina: function(res) {
        var current, id;
        id = "btcchina";
        current = {
          bid: $filter('round')(res.ticker.buy / USDCNY, 2),
          ask: $filter('round')(res.ticker.sell / USDCNY, 2),
          last: $filter('round')(res.ticker.last / USDCNY, 2),
          updateTime: null,
          error: null
        };
        checkAndCopy(id, current);
      },
      localbitcoins: function(res) {}
    };
    _ref = exchangeSvc.data;
    for (name in _ref) {
      data = _ref[name];
      if (data.api.type === "REST") {
        myResource = $resource(data.api.uri);
        pollers.push({
          id: name,
          item: poller.get(myResource, {
            action: 'get',
            delay: 1000 * 5
          })
        });
      }
    }
    for (_i = 0, _len = pollers.length; _i < _len; _i++) {
      poller = pollers[_i];
      poller.item.promise.then(null, null, callback[poller.id]);
    }
  });

  angular.module('app').factory('socket', function(socketFactory) {
    return socketFactory({
      ioSocket: io.connect('http://socketio.mtgox.com:80/mtgox?Currency=USD')
    });
  });

  angular.module('app').controller('AppCtrl', function(socket, exchangeSvc, $scope) {
    var channel, obj, _ref,
      _this = this;
    this.price = void 0;
    this.unsubscribe = {
      depthBTCUSD: {
        op: 'unsubscribe',
        channel: '24e67e0d-1cad-4cc0-9e7a-f8523ef460fe'
      },
      tradeBTC: {
        op: 'unsubscribe',
        channel: 'dbf1dee9-4f2e-4a08-8cb7-748919a71b21'
      }
    };
    socket.on('connect', function() {
      console.log("Connected.");
    });
    _ref = this.unsubscribe;
    for (channel in _ref) {
      obj = _ref[channel];
      socket.send(JSON.stringify(obj));
    }
    socket.on('message', function(res) {
      try {
        _this.price = res.ticker.last.display_short;
      } catch (_error) {}
    });
    $scope.$on("btcchinaUpdate", function(event, data) {
      return _this.price2 = exchangeSvc.data["btcchina"].fetched.current.last;
    });
  });

}).call(this);

/*
//@ sourceMappingURL=app.map
*/
